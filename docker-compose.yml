version: '3.8'

services:
  bunq-dashboard:
    build: .
    container_name: bunq-dashboard
    restart: unless-stopped
    
    ports:
      # Single port for both API and Frontend (simplified architecture)
      - "5000:5000"
    
    environment:
      # Vaultwarden Configuration (RECOMMENDED)
      VAULTWARDEN_URL: "${VAULTWARDEN_URL:-http://vaultwarden:80}"
      VAULTWARDEN_CLIENT_ID: "${VAULTWARDEN_CLIENT_ID}"
      VAULTWARDEN_CLIENT_SECRET: "${VAULTWARDEN_CLIENT_SECRET}"
      VAULTWARDEN_ITEM_NAME: "${VAULTWARDEN_ITEM_NAME:-Bunq API Key}"
      USE_VAULTWARDEN: "${USE_VAULTWARDEN:-true}"
      
      # Alternative: Direct API Key (NOT RECOMMENDED)
      # BUNQ_API_KEY: "${BUNQ_API_KEY}"
      
      # Bunq Configuration
      BUNQ_ENVIRONMENT: "${BUNQ_ENVIRONMENT:-PRODUCTION}"
      
      # Flask Configuration
      FLASK_DEBUG: "${FLASK_DEBUG:-False}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    
    volumes:
      - bunq-config:/app/config
      - bunq-logs:/app/logs
    
    depends_on:
      - vaultwarden
    
    networks:
      - bunq-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
  
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    
    ports:
      - "8080:80"
    
    volumes:
      - vaultwarden-data:/data
    
    environment:
      DOMAIN: "${VAULTWARDEN_DOMAIN:-http://localhost:8080}"
      SIGNUPS_ALLOWED: "${VAULTWARDEN_SIGNUPS:-false}"
    
    networks:
      - bunq-network

volumes:
  bunq-config:
  bunq-logs:
  vaultwarden-data:

networks:
  bunq-network:
    driver: bridge
